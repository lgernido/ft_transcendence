{% load static %}
<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'chat/css/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <title>Messagerie</title>

</head>
<body>
    <div id="container">
        <div id="sidebar" class="p-3">
            <!-- Barre de recherche -->
            <form class="mb-4">
                <div class="input-group">
                    <input type="text" class="form-control" id="userSearchInput" placeholder="Rechercher un utilisateur..." aria-label="Recherche">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i> <!-- Ic√¥ne de recherche Bootstrap -->
                    </span>
                </div>
            </form>
        
            <!-- Liste des personnes avec qui l'utilisateur a √©chang√© -->
            <div id="userList">
                <div class="user-entry d-flex align-items-center mb-3">
                    <img src="" alt="Avatar de l'utilisateur" class="img-fluid rounded-circle me-3" style="width: 50px; height: 50px;">
                </div>
                <!-- R√©p√©tez le mod√®le de user-entry pour chaque utilisateur -->
            </div>
        </div>
        <div id="chat-area">
            <div class="chat-header d-flex align-items-center">
                <!-- Info de la personne avec qui je parle  -->
                <img src="" alt="Avatar du contact" class="rounded-circle me-3"> 
                <div class="contact-details">
                    <strong>Nom du contact</strong>
                </div>
            </div>
            <div class="messages-container">
                <!-- Listes des messages envoyer et recu -->
            </div>
            <div class="chat-footer">
                <form id="message-form" class="d-flex">
                    <textarea type="text" id="message-input" class="form-control me-2" placeholder="Write your best win üòà" autocomplete="off" required></textarea>
                    <button type="submit" class="btn btn-primary">
                        <img src="{% static 'chat/img/envoyer.png' %}" alt="Envoyer">
                    </button>
                </form>
            </div>
        </div>
    </div>
    <script>
        
    let current_user = null 
    
    fetch(`/chat2/get_current_user`)
    .then(response => response.json())  // Correction ici, ajout de la parenth√®se fermante
    .then(data => {
        if (data) {
            current_user = data.current_user;  // Stocker les donn√©es dans current_user
            console.log(current_user);  // Afficher current_user
        } else {
            console.log("No data");
        }
    })
    .catch(error => {
        console.error("Error fetching data:", error);
    });

        document.addEventListener("DOMContentLoaded", () => {
    const chatArea = document.querySelector(".messages-container");
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");
    const userSearchInput = document.getElementById("userSearchInput");
    const userList = document.getElementById("userList");
    const chatHeader = document.querySelector(".contact-details strong");

    let currentChannelId = null;
    let chatSocket = null;

    // Fonction pour initialiser WebSocket pour le canal sp√©cifi√©
    function initWebSocket(channelId) {
        if (chatSocket) {
            chatSocket.close(); // Fermer la connexion pr√©c√©dente si elle existe
        }

        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const wsUrl = `${wsScheme}://${window.location.host}/ws/chat2/chat/private_${channelId}/`;
        chatSocket = new WebSocket(wsUrl);
        console.log(chatSocket);

        chatSocket.onopen = function () {
            console.log("WebSocket connected to channel:", channelId);
        };

        chatSocket.onclose = function () {
            console.log("WebSocket closed for channel:", channelId);
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            const messageElement = document.createElement("p");
            messageElement.textContent = `${data.sender}: ${data.message}`;
            messageElement.classList.add(data.sender === current_user ? "send" : "receive");
            console.log(data.sender);
            console.log(current_user);
            chatArea.appendChild(messageElement);
            chatArea.scrollTop = chatArea.scrollHeight;
        };
    }

    window.addEventListener('beforeunload', () => {
        if (chatSocket) {
            chatSocket.close();  // Fermer proprement la connexion WebSocket
            console.log('Connexion WebSocket ferm√©e avant de quitter la page');
        }
    });

    // Fonction pour charger les messages d'un canal
    function loadMessages(channelId) {
        console.log("Chargement des messages pour le canal:", channelId);
        fetch(`/chat2/load_messages?query=${channelId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to load messages");
                }
                return response.json();
            })
            .then(data => {
                chatArea.innerHTML = "";  // R√©initialiser la zone de messages
                console.log(data.messages);
                data.messages.forEach(msg => {
                    const messageElement = document.createElement("p");
                    messageElement.textContent = `${msg.sender__username}: ${msg.content}`;
                    messageElement.classList.add(msg.sender__username === current_user ? "send" : "receive");
                    
                    chatArea.appendChild(messageElement);
                });
                chatArea.scrollTop = chatArea.scrollHeight;
            })
            .catch(error => {
            console.error("Erreur lors du chargement des messages :", error);
            chatArea.innerHTML = "<p>Impossible de charger les messages. Essayez plus tard.</p>";
        });
    }

    // Fonction pour g√©rer le clic sur un utilisateur de la liste
    function handleUserClick(user) {
        const user2Id = user.id; // ID de l'utilisateur s√©lectionn√©
        // Mettre √† jour le nom du contact dans le chat header
        chatHeader.textContent = user.username;

        // Charger les anciens messages et √©tablir la connexion WebSocket pour le nouveau canal
        loadMessages(user.id);
        initWebSocket(user.id);
    }

    // Envoi de messages via le WebSocket
    messageForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message && chatSocket) {
            chatSocket.send(JSON.stringify({
                "message": message
            }));
            messageInput.value = "";
        }
    });
// ==============================================================================================
    // Recherche d'utilisateurs
    userSearchInput.addEventListener("input", function () {
        const query = userSearchInput.value.trim();
        if (query.length >= 2) {
            fetch(`/chat2/search_users?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    userList.innerHTML = "";
                    data.results.forEach(user => {
                        const userEntry = document.createElement("div");
                        userEntry.classList.add("user-entry", "d-flex", "align-items-center", "mb-3");
                        userEntry.innerHTML = `
                            <img src="" alt="Avatar" class="img-fluid rounded-circle me-3" style="width: 50px; height: 50px;">
                            <div>
                                <div class="user-details"><strong>${user.username}</strong></div>
                                <div class="last-message text-muted">${user.last_message || "Aucun message"}</div>
                            </div>
                        `;
                        userEntry.addEventListener("click", () => handleUserClick(user)); // Attacher l'√©v√©nement clic
                        userList.appendChild(userEntry);
                    });
                });
        } else {
            userList.innerHTML = ""; // Effacer la liste si la recherche est vide
        }
    });
});
//=========================================
    // function fetchUserConversations() {
    //     fetch('/chat2/user_conversations/')
    //         .then(response => response.json())
    //         .then(data => {
    //             console.log('Conversations utilisateur :', data);
    //         })
    //         .catch(error => {
    //             console.error('Erreur lors de la requ√™te :', error);
    //         });
    // }

    // // Lancer la fonction toutes les 1 seconde
    //  setInterval(fetchUserConversations, 10000);
//===========================================

// Cr√©e une nouvelle connexion WebSocket avec l'URL de votre WebSocket
const socket = new WebSocket('ws://localhost:8000/ws/chat2/conversations/');

// Lorsque la connexion WebSocket est ouverte
socket.onopen = function(e) {
    console.log("Connexion WebSocket r√©ussie !");
    // Vous pouvez envoyer un message de demande si n√©cessaire (mais ici c'est optionnel)
    // socket.send(JSON.stringify({
    //     type: 'request_conversations',
    // }));
};

// Lorsque vous recevez un message depuis le serveur
socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    console.log('Message re√ßu:', data);
    
    // V√©rification si on re√ßoit les conversations
    if (data.conversations) {
        // Traitez les conversations re√ßues
        console.log('Conversations:', data.conversations);
        
        // Mettez √† jour l'interface utilisateur avec les conversations
        const conversationList = document.querySelector('#conversation-list');
        conversationList.innerHTML = '';  // Vider les conversations existantes

        data.conversations.forEach(conv => {
            const conversationItem = document.createElement('div');
            conversationItem.classList.add('conversation-item');
            conversationItem.textContent = `Conversation: ${conv.channel_name}`;
            conversationList.appendChild(conversationItem);
        });
    }

    // V√©rification si on re√ßoit un nouveau message
    if (data.sender && data.content && data.timestamp) {
        console.log('Nouveau message:', data);

        // Mettez √† jour l'interface utilisateur avec le nouveau message
        const messageContainer = document.querySelector('#messages');
        const messageElement = document.createElement('div');
        messageElement.textContent = `${data.sender}: ${data.content} (${data.timestamp})`;
        messageContainer.appendChild(messageElement);
    }
};

// Si la connexion WebSocket est ferm√©e
socket.onclose = function(e) {
    console.error('Connexion WebSocket ferm√©e:', e);
};

// Si une erreur se produit sur la connexion WebSocket
socket.onerror = function(e) {
    console.error('Erreur WebSocket:', e);
};


    </script>
</body>
</html>

