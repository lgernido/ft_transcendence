{% load static %}
<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXhW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'chat/css/styles.css' %}">
    <title>Messagerie</title>

</head>
<body>
    <div id="container">
        <div id="sidebar" class="p-3">
            <!-- Barre de recherche -->
            <form class="mb-4">
                <div class="input-group">
                    <input type="text" class="form-control" id="userSearchInput" placeholder="Rechercher un utilisateur..." aria-label="Recherche">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i> <!-- Ic√¥ne de recherche Bootstrap -->
                    </span>
                </div>
            </form>
        
            <!-- Liste des personnes avec qui l'utilisateur a √©chang√© -->
            <div id="userList">
                <div class="user-entry d-flex align-items-center mb-3">
                    <img src="" alt="Avatar de l'utilisateur" class="img-fluid rounded-circle me-3" style="width: 50px; height: 50px;">
                    <div>
                        <div class="user-details"><strong>Nom d'utilisateur</strong></div>
                        <div class="last-message text-muted">Dernier message envoy√©</div>
                    </div>
                </div>
                <!-- R√©p√©tez le mod√®le de user-entry pour chaque utilisateur -->
            </div>
        </div>
        <div id="chat-area">
            <div class="chat-header d-flex align-items-center">
                <!-- Info de la personne avec qui je parle  -->
                <img src="" alt="Avatar du contact" class="rounded-circle me-3"> 
                <div class="contact-details">
                    <strong>Nom du contact</strong>
                </div>
            </div>
            <div class="messages-container">
                <!-- Listes des messages envoyer et recu -->
                <p class="send"> Salut ca va ?</p>
                <p class="receive"> Oui je vais bien et toi ?</p>
            </div>
            <div class="chat-footer">
                <form id="message-form" class="d-flex">
                    <textarea type="text" id="message-input" class="form-control me-2" placeholder="Write your best win üòà" autocomplete="off" required></textarea>
                    <button type="submit" class="btn btn-primary">
                        <img src="{% static 'chat/img/envoyer.png' %}" alt="Envoyer">
                    </button>
                </form>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const userSearchInput = document.getElementById("userSearchInput");
            const userList = document.getElementById("userList");
            const messageInput = document.getElementById("message-input");
            const messageForm = document.getElementById("message-form");
            const messagesContainer = document.querySelector(".messages-container");
            const chatArea = document.getElementById("chat-area");

            let currentChatSocket = null;
            let currentUserId = null;

            function openChat(channelId) {
                if (currentChatSocket) {
                    currentChatSocket.close();
                }
                currentUserId = channelId;
                const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
                currentChatSocket = new WebSocket(`${wsProtocol}://${window.location.host}/ws/chat/${channelId}/`);
                
                currentChatSocket.onopen = function () {
                    console.log("Connected to WebSocket for channel ID:", channelId);
                    messagesContainer.innerHTML = '';
                };

                currentChatSocket.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    addMessage(data.sender, data.message, data.timestamp, data.message_id);
                };

                currentChatSocket.onclose = function () {
                    console.log("WebSocket connection closed");
                };

                window.addEventListener("beforeunload", () => {
                    if (currentChatSocket) {
                        currentChatSocket.close();
                    }
                });
            }

            function addMessage(sender, message, timestamp, messageId) {
                const messageElement = document.createElement("div");
                messageElement.classList.add("message");
                messageElement.innerHTML = `
                    <strong>${sender}</strong>: ${message} <br>
                    <small>${timestamp}</small>
                `;
                messagesContainer.appendChild(messageElement);
            }

            messageForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const message = messageInput.value.trim();
                if (message && currentChatSocket) {
                    currentChatSocket.send(JSON.stringify({
                        "message": message,
                    }));
                    messageInput.value = "";
                }
            });

            userList.addEventListener("click", function (event) {
                const userEntry = event.target.closest(".user-entry");
                if (userEntry) {
                    const channelId = userEntry.getAttribute("data-channel-id");
                    openChat(channelId);
                }
            });

            userSearchInput.addEventListener('input', function() {
                var query = this.value;
                
                if (query.length >= 2) {
                    fetch(`/search-users/?query=${query}`)
                        .then(response => {
                            if (!response.ok) {
                                console.error(response);
                                throw new Error('La r√©ponse du r√©seau n\'√©tait pas correcte');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(data);
                            let resultsContainer = document.getElementById('userListResults');
                            resultsContainer.innerHTML = '';

                            data.results.forEach(user => {
                                console.log(user);
                                let userEntry = document.createElement('div');
                                userEntry.classList.add('user-entry', 'd-flex', 'align-items-center', 'mb-3');
                                userEntry.setAttribute('data-channel-id', user.channel_id); // Supposons que vous avez channel_id dans les donn√©es utilisateur
                                userEntry.innerHTML = `
                                    <div>
                                        <div class="user-details">
                                            <strong>${user.username}</strong>
                                        </div>
                                    </div>
                                `;
                                resultsContainer.appendChild(userEntry);
                            });
                        })
                        .catch(error => console.error('Erreur lors de la r√©cup√©ration des r√©sultats de recherche:', error));
                }
            });
        });
    </script>
</body>
</html>

